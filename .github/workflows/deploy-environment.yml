name: deploy-environment

on:
    workflow_call:
        inputs:
            environment:
                description: "Environment name"
                required: true
                type: string

permissions:
    id-token: write
    contents: read

defaults:
    run:
        shell: bash

jobs:
    deploy-environment:
        runs-on: ubuntu-latest
        environment: ${{inputs.environment}}
        steps:
            - name: Generate App token
              id: app-token
              uses: actions/create-github-app-token@v1
              with:
                  app-id: ${{ secrets.SUBMODULE_APP_ID }}
                  private-key: ${{ secrets.SUBMODULE_APP_PRIVATE_KEY }}
                  owner: IronForgedClan

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ steps.app-token.outputs.token }}
                  submodules: recursive

            - name: Read version
              id: version
              run: echo "VERSION=$(cat VERSION)" >> $GITHUB_ENV

            - name: Send warning message
              env:
                  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{"content": "## ⏸️ Installing an update..."}' \
                  $WEBHOOK_URL

            - name: Set up keys
              env:
                  KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
                  PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
              run: |
                install -m 600 -D /dev/null ~/.ssh/id_rsa
                echo "$PRIVATE_KEY" > ~/.ssh/id_rsa
                echo "$KNOWN_HOSTS" > ~/.ssh/known_hosts

            - name: Deploy
              env:
                SSH_USER: ${{ secrets.SSH_USER }}
                SSH_HOST: ${{ secrets.SSH_HOST }}
                BOT_DIR: ${{ secrets.BOT_DIR }}
              run: |
                ssh $SSH_USER@$SSH_HOST "
                cd $BOT_DIR
                /bin/bash deploy.sh ${{ inputs.environment }}
                "

            - name: Send success message
              env:
                  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{"content": "## 🟢 v${{ env.VERSION }} ONLINE.\nDetails can be found in the <#${{ secrets.CHANGELOG_CHANNEL_ID }}> channel."}' \
                  $WEBHOOK_URL
